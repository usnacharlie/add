{% extends "base.html" %}

{% block content_wrapper %}
<div class="container-fluid px-0">
    <div class="row g-0">
        <!-- Member Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky pt-3">
                <!-- Member Info Card -->
                <div class="card mx-3 mb-3">
                    <div class="card-body text-center">
                        <div class="user-avatar mx-auto mb-2" style="width: 60px; height: 60px; font-size: 24px;">
                            {{ session.user_name[0].upper() if session.user_name else 'U' }}
                        </div>
                        <h6 class="mb-0">{{ session.user_name|default('Member') }}</h6>
                        <small class="text-muted">{{ session.membership_number|default('PM00000000') }}</small>
                    </div>
                </div>

                <!-- Navigation -->
                <ul class="nav flex-column px-3">
                    {% for item in member_navigation %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == item.endpoint %}active{% endif %}"
                           href="{{ url_for(item.endpoint) }}">
                            <i class="fas fa-{{ item.icon }} me-2"></i>
                            {{ item.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>

                <!-- Quick Actions -->
                <div class="px-3 mt-4">
                    <h6 class="sidebar-heading text-muted">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal">
                            <i class="fas fa-credit-card"></i> Make Payment
                        </button>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#eventModal">
                            <i class="fas fa-calendar-plus"></i> Register for Event
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Page Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    {% block page_actions %}{% endblock %}
                </div>
            </div>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('member.dashboard') }}">Dashboard</a></li>
                    {% block breadcrumb %}{% endblock %}
                </ol>
            </nav>

            <!-- Content -->
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Make Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickPaymentForm">
                    <div class="mb-3">
                        <label for="paymentType" class="form-label">Payment Type</label>
                        <select class="form-select" id="paymentType" required>
                            <option value="">Select payment type</option>
                            <option value="membership">Membership Fee</option>
                            <option value="donation">Donation</option>
                            <option value="event">Event Registration</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (ZMW)</label>
                        <input type="number" class="form-control" id="amount" required min="1" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="">Select method</option>
                            <option value="mtn">MTN Money</option>
                            <option value="airtel">Airtel Money</option>
                            <option value="zanaco">Zanaco Express</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processPayment()">Process Payment</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Registration Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register for Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventRegistrationForm">
                    <div class="mb-3">
                        <label for="eventSelect" class="form-label">Select Event</label>
                        <select class="form-select" id="eventSelect" required>
                            <option value="">Loading events...</option>
                        </select>
                    </div>
                    <div id="eventDetails" class="d-none">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Event Details</h6>
                            <p id="eventInfo"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="registerForEvent()">Register</button>
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    position: fixed;
    top: 56px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    min-height: calc(100vh - 56px);
}

.sidebar-sticky {
    position: sticky;
    top: 0;
    height: calc(100vh - 48px);
    padding-top: .5rem;
    overflow-x: hidden;
    overflow-y: auto;
}

.sidebar .nav-link {
    color: #333;
    padding: .5rem 1rem;
    border-radius: .25rem;
    transition: all .3s;
}

.sidebar .nav-link:hover {
    background-color: #e9ecef;
}

.sidebar .nav-link.active {
    color: #fff;
    background-color: #0d6efd;
}

.sidebar-heading {
    font-size: .75rem;
    text-transform: uppercase;
}

main {
    margin-left: 16.666667%;
}

@media (max-width: 767.98px) {
    .sidebar {
        position: static;
        padding: 0;
    }

    main {
        margin-left: 0;
    }
}
</style>

<script>
// Load upcoming events for registration modal
$('#eventModal').on('show.bs.modal', function() {
    $.ajax({
        url: '/api/events/upcoming',
        method: 'GET',
        success: function(data) {
            let options = '<option value="">Select an event</option>';
            data.events.forEach(event => {
                options += `<option value="${event.id}">${event.name} - ${event.date}</option>`;
            });
            $('#eventSelect').html(options);
        }
    });
});

// Show event details when selected
$('#eventSelect').on('change', function() {
    const eventId = $(this).val();
    if (eventId) {
        // Fetch event details
        $.ajax({
            url: `/api/events/${eventId}`,
            method: 'GET',
            success: function(event) {
                $('#eventInfo').html(`
                    <strong>Date:</strong> ${event.date}<br>
                    <strong>Time:</strong> ${event.time}<br>
                    <strong>Location:</strong> ${event.location}<br>
                    <strong>Fee:</strong> K${event.fee || 'Free'}
                `);
                $('#eventDetails').removeClass('d-none');
            }
        });
    } else {
        $('#eventDetails').addClass('d-none');
    }
});

function processPayment() {
    // Implement payment processing
    Swal.fire('Processing', 'Payment processing initiated...', 'info');
}

function registerForEvent() {
    // Implement event registration
    Swal.fire('Success', 'You have been registered for the event!', 'success');
}
</script>
{% endblock %}